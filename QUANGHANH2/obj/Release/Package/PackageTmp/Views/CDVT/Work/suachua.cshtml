@{
    ViewData["Title"] = "suachua";
    Layout = "~/Views/Shared/_Layout_CDVT.cshtml";
}

<link href="~/assets/Custom css/CDVT/TABLE_BORDERED.css" rel="stylesheet" />
<link href="~/lib/datepicker_src/dist/css/datepicker.min.css" rel="stylesheet" type="text/css">
<link href="~/lib/datepicker_src/css/style.css" rel="stylesheet " type="text/css ">
<link href="~/lib/datepicker_src/dist/css/datepicker.min.css " rel="stylesheet " type="text/css ">
<link href="~/lib/datepicker_src/dist/css/custom.css " rel="stylesheet " type="text/css ">
<link href="~/lib/datepicker_src/dist/css/font.css" rel="stylesheet" type="text/css">
<script src="~/lib/datepicker_src/dist/js/datepicker.js"></script>
<script src="~/lib/datepicker_src/dist/js/i18n/datepicker.vi.js"></script>
<div class="col m12">
    <div class="card">
        <div class="card-content">
            <div class="row">
                <h3 class="center"><b>SỬA CHỮA THIẾT BỊ</b></h3>
                <div class="col l6 m6 s12">
                    <div class="row">
                        <div class="col l8 m8 s12 offset-l1 offset-m1 input-field">
                            <input type="text" placeholder="Tìm kiếm theo phân xưởng" class='form-control' id="searchArea"
                                   multiple />
                        </div>
                        <div class="col l8 m8 s12 offset-l1 offset-m1 input-field">
                            <input type="text" placeholder="Tìm kiếm theo mã thiết bị" class='form-control' id="searchArea"
                                   multiple />
                        </div>
                        <div class="col l8 m8 s12 offset-l1 offset-m1 input-field">
                            <input type="text" placeholder="Tìm kiếm theo tên thiết bị" class='form-control' id="searchArea"
                                   multiple />
                        </div>
                        <div class="col l8 m8 s6 offset-l2 offset-m2 input-field">
                            <button class="btn blue darken-2 btn-small" id="searchButton1">Tìm kiếm</button>
                        </div>
                    </div>
                </div>

            </div>
            <div id="table-wrapper">
                <div>
                    <form id="frm">
                        <div class="row">
                            <table id="equipmentTable" class="striped table-responsive">
                                <thead>
                                    <tr>
                                        <th>Số thứ tự</th>
                                        <th>Mã thiết bị</th>
                                        <th>Tên thiết bị</th>
                                        <th>Phân xưởng quản lí</th>
                                        <th>Tình trạng thiết bị</th>
                                        <th></th>
                                    </tr>
                                </thead>
                            </table>
                            <a href="/phong-cdvt/sua-chua-chon" id="tienhanh" onclick="SaveStatus()" class="btn blue darken - 2">Tiến hành điều động sửa chữa</a>
                            <a class="btn blue darken - 2" onclick="SaveStatus()">Save </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" src="~/js/Custom JS/CDVT/Work/suachua.js"></script>
<link href="//cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css" rel="stylesheet" />
@section scripts{
    <script src="//cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script>
        var Popup, dataTable;
        @{
            var listFromServer = "[]";
            if (ViewBag.selectedList != null)
            {
                listFromServer = ViewBag.selectedList;
            }
         }
        var arrCarSelected = JSON.parse("@listFromServer".replace(/(&quot\;)/g, "\""));
        $(document).ready(function () {
                            dataTable = $('#equipmentTable')
                                .on('preXhr.dt', function ( e, settings, data )  {
                                data.sessionId = "@ViewBag.id";
                                data.selectList = JSON.stringify(arrCarSelected);
                            })
                .DataTable({
                                "ajax": {
                                    "url": "/phong-cdvt/sua-chua",
                                "type": "POST",
                                "datatype": "json",
                },
                    "columns": [
                        {
                            "data": "equipmentId", "name": "equipmentId", "render": function (data) {
                                return "<span class='center'>" + data + "</span>"
                            }
                        },
                        { "data": "equipmentId", "name": "equipmentId", "searchable": true },
                        { "data": "equipment_name", "name": "equipment_name" },
                        { "data": "department_id", "name": "department_id" },
                        { "data": "current_Status", "name": "current_Status" },
                        {
                            "data": "equipmentId", "render": function (data) {
                                if (arrCarSelected != null) {
                                    for (let i = 0; i < arrCarSelected.length; i++)
                                        if (arrCarSelected[i] == data) {
                                            return "<label><input class='my_checkbox'  name='abc' id ='" + data + "' value='" + data + "' type ='checkbox' onclick=updateList('" + data + "') checked><span></span></label>";
                                        }
                                }
                                return "<label><input class='my_checkbox'  name='abc' id ='" + data + "' value='" + data + "' type ='checkbox' onclick=updateList('" + data + "')><span></span></label>";
                            },
                        "orderable": false,
                        "searchable": false,
                        "width": "150px"
                    }
                ],
                "serverSide": "true",
                "order": [4, "desc"]

            });

            
            function changeState(value, state) {
                $.ajax({
                type: "POST",
                    url: "/sua-chua/save-session/",
                    data: {
                    id: JSON.stringify(value),
                        state: JSON.stringify(state)
                    },
                    dataType: "json",
                    success: function (data) {
                        alert("here" + data.d.toString());
                    }
                });
            }
        });



        //function updateList(id) {
        //        isExist = false;
        //        for (let i = 0; i < arrCarSelected.length; i++) {
        //            if (arrCarSelected[i] == id) {
        //                isExist = true;
        //                arrCarSelected.splice(i, 1);
        //                break;
        //            }
        //        }
        //        if (!isExist && id != "" && id != null) {
        //            arrCarSelected.push(id);
        //    }
        //}

        function updateList(id) {
            isExist = false;
            for (let i = 0; i < arrCarSelected.length; i++) {
                if (arrCarSelected[i] == id) {
                    isExist = true;
                    arrCarSelected.splice(i, 1);
                    break;
                }
            }
            if (!isExist && id != "" && id != null) {
                arrCarSelected.push(id);
                console.log(arrCarSelected)
            }
        }



        function SaveStatus() {
            $.ajax({
                url: "/phong-cdvt/sua-chua",
                method: "POST",
                data: {
                  "selectList" : JSON.stringify(arrCarSelected)
                }
            })
        }
            function sendData() {
            $.each($("input[name='abc']:checked"), function () {
                });

        }


    </script>
}