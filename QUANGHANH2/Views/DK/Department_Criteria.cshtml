
@{
    ViewBag.Title = "Department_Criteria";
    Layout = "~/Views/Shared/_Layout_DK.cshtml";
}

<link href="~/assets/Custom css/TABLE_BORDERED.css" rel="stylesheet" />
<link href="~/assets/Custom css/form-input-border.css" rel="stylesheet" />
<div class="card">
    <div class="card-content">
        <h3 class="center">TIÊU CHÍ CHO PHÒNG BAN</h3>
        <div class="row">
            <div class="input-field col l3 m12 s12">
                <input type="text" id="monthCalendar" class="form-control datepicker-here datepicker-add center"
                       data-language='vi'
                       data-min-view="months"
                       data-view="months"
                       data-date-format="Tháng mm"
                       required placeholder="Tháng" />
            </div>
            <div class="input-field col l3 m12 s12">
                <input type="text" id="yearCalendar" class="form-control datepicker-here datepicker-add center"
                       data-language='vi'
                       data-min-view="years"
                       data-view="years"
                       data-date-format="Năm yyyy"
                       required placeholder="Năm" />
            </div>
            <div class="input-field col l3 m12 s12">
                <select class="form-control" id="cbx-px" name="px_value">
                    <option value="default-px" disabled selected>Phân xưởng</option>
                    <option value="PXKT1">Khai thác 1</option>
                    <option value="PXKT2">Khai thác 2</option>
                    <option value="PXKT3">Khai thác 3</option>
                    <option value="PXKT4">Khai thác 4</option>
                    <option value="PXKT5">Khai thác 5</option>
                    <option value="PXKT6">Khai thác 6</option>
                    <option value="PXKT7">Khai thác 7</option>
                    <option value="PXKT8">Khai thác 8</option>
                    <option value="PXKT9">Khai thác 9</option>
                    <option value="PXKT10">Khai thác 10</option>
                    <option value="PXKT11">Khai thác 11</option>
                    <option value="PXDL3">Đào lò 3</option>
                    <option value="PXDL5">Đào lò 5</option>
                    <option value="PXDL7">Đào lò 7</option>
                    <option value="PXDL8">Đào lò 8</option>
                    <option value="PXDL2">Thăng Long</option>
                    <option value="CTA">Asean</option>
                    <option value="PXDL1">Xây lắp mỏ</option>
                    <option value="PXST">Sàng tuyển</option>
                    <option value="PXLT">Lộ thiên</option>
                    <option value="KCS">KCS</option>
                </select>
            </div>
            <div class="input-field col l3 m12 s12 center">
                <a class="btn blue darken-2" onclick="getInformation()">XEM</a>
            </div>
            <div class="row">
                <div class="col s12 m12 l12">
                    <table class="table-bordered" id="aspectDetailTable">
                        <thead>
                            <tr>
                                <th>Tiêu chí</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="col s12 m12 l12 input-field right row">
                    <a class="btn blue darken-2" onclick="addRows()" id="addRowsbtn">Thêm</a>
                </div>

            </div>
            <div class="col s12 m12 l12 input-field center row">
                <button class="btn blue darken-2" type="submit" id="EditSaveBtn" onclick="EditOrUpdate()">CHỈNH SỬA</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        $('select').formSelect();
        mode = 0;
        $('#addRowsbtn').hide();
        listAspectDepartments = [];
    });
    var dem = 0;

    function addRows() {
        tableBody = $("#aspectDetailTable").children("tbody");
        content = tableBody.html();

        selectContent = "<select id=\"MaTieuChi" + dem + "\" onclick=\"searchUnit(this)\"class=\"browser-default\" onchange=\"return checkDuplicate(this);\" skipped=\"0\"> <option value=\"\" selected disabled>Lựa chọn tiêu chí</option>";
        unit = "";

        for (let i = 0; i < listAspectDepartments.length; i++) {
            selectContent += "<option id=\""+ listAspectDepartments[i].MaTieuChi + "\" value=\"" + listAspectDepartments[i].MaTieuChi + "\">" + listAspectDepartments[i].TenTieuChi + "</option>"

        }
        selectContent += "</select>"
        dem++;
        tableBody.append(selectContent);
      }

</script>
<script>
    function getInformation() {
        if ($('#monthCalendar').val() == "" || $('#yearCalendar').val() == ""||$('#cbx-px').val() == null)
            return false;
        $('#pre-load').show();
        console.log($("#monthCalendar").val().split(" ")[1]);
        console.log($("#yearCalendar").val().split(" ")[1]);
        console.log($("#cbx-px").val());
        $.ajax({
            type: 'post',
            url: '/phong-dieu-khien/nhap-lieu-phong-ban-tieu-chi/lay-thong-tin',
            data: {
                'month': $("#monthCalendar").val().split(" ")[1],
                'year': $("#yearCalendar").val().split(" ")[1],
                'department': $("#cbx-px").val(),

            },
            success: function (response) {
                tableBody = $("#aspectDetailTable").children("tbody");
                tableBody.empty();
                content = "";
                let reponseListPhongBanTieuChi = response.listPhongBanTieuChi
                if (reponseListPhongBanTieuChi.length > 1) {
                    for (let i = 0; i < reponseListPhongBanTieuChi.length; i++) {
                        content += "<tr><td class=\"aspectName\" id=\"" + reponseListPhongBanTieuChi[i].MaTieuChi + "\">" + reponseListPhongBanTieuChi[i].TenTieuChi + "</td><tr>";
                    }
                } else {

                }
                tableBody.html(content);
                ViewMode();
                mode = 0;
                listAspectDepartments = response.listTieuChi;
                //$("#totalDays").attr("value", response.totalDays)
                //$("#headerIDhidden").attr("value", response.headerID)
                //$("#totalDays").attr("disable", "disable")
                $('#pre-load').hide();
            },
            error: function (response) {

            }
        })
    }

    function check() {
        tableBodyRows = $("#aspectDetailTable tbody tr")
            .each(function () {
                $(this).find("td").each(function (i, v) {
                    console.log($(this).val)
                })
            });
    }

    function ViewMode() {
        $("#EditSaveBtn").html("<i class=\"material-icons right\">border_color</i>CẬP NHẬT");
        $('#addRowsbtn').hide();
        //
        $("#totalDays").attr("disable", true)
    }

    function EditMode() {
        $("#EditSaveBtn").html("<i class=\"material-icons right\">border_color</i>LƯU");
        $('#addRowsbtn').show();
        //
        $("#totalDays").removeAttr("disabled")
    }

    function EditOrUpdate() {
        if (mode == 0) {
            //View Mode -> Edit
            EditMode();
            $('.editableContent').each(function () {
                content = $(this).text();
                console.log($(this).attr("id"))
                if ($(this).attr("id").includes("amount")) {
                    $(this).html("<input type=\"number\" value=\"" + content + "\">")
                } else {
                    $(this).html("<input type=\"text\" value=\"" + content + "\">")
                }
            })

        } else {
            // Edit Mode -> View
            sendUpdateData(getDataFromTable());
            $('.editableContent').each(function () {
                content = $(this).children("input").val();
                console.log($(this).attr("id"))
                $(this).html(content);
            })
            ViewMode();
        }
        mode = 1 - mode;
    }


    function checkDuplicate(selectTag) {
        selectedValue = selectTag.options[selectTag.selectedIndex].value;
        var listTieuChiValue = [];
        $("#aspectDetailTable").find("select").each(function () {
            listTieuChiValue.push($(this).val());
            $("option:not(option#" + $(this).val() + ")").removeAttr("disabled", "disabled");
            $("option#" + $(this).val()).attr("disabled", "disabled");
        });


    }

    function getDataFromTable() {
        data = {};
        headerID = null;
        list = [];
        heads = ["MaTieuChi", "DonViDo", "SanLuong", "GhiChu"]
        tableBody = $("#aspectDetailTable").children("tbody");
        tableBody.children("tr:even").each(function () {
            if ($(this).children("td").hasClass("aspectAdded")) {
                if ($(this).children("td").children("select").attr("skipped") == "0") {
                    cur = {}
                    cur["HeaderID"] = $("#headerIDhidden").attr("value");
                    $(this).children("td").each(function (i, v) {
                        switch (i) {
                            case 0:
                                cur[heads[i]] = parseInt($(this).children("select").val());
                                break;
                            case 2:
                            case 3:
                                cur[heads[i]] = $(this).children("input").val()
                                break;
                            //case 1:
                            //    cur[heads[i]] = $(this).html()
                            default:
                                break;
                        }
                    })
                    if (!isNaN(cur["MaTieuChi"])) {
                        if (cur["SanLuong"] == null) {
                            cur["SanLuong"] = 0;
                        }
                        list.push(cur)
                    }
                }
            } else {
                cur = {}
                cur["HeaderID"] = $("#headerIDhidden").attr("value");
                $(this).children("td").each(function (i, v) {
                    switch (i) {
                        case 0:
                            cur[heads[i]] = $(this).attr("id").split("-")[0]
                            break;
                        case 2:
                        case 3:
                            cur[heads[i]] = $(this).children("input").val()
                            break;
                        default:
                            break;
                    }
                })
                list.push(cur)
            }
        })
        if (headerID != null) {
            for (let i = 0; i < list.length; i++) {
                if (list[i]["HeaderID"] == null) {
                    list[i]["HeaderID"] = headerID;
                }
            }
        }
        return JSON.stringify(list)
    }

    function sendUpdateData(data) {
        setTimeout($('#pre-load').show(),3000)
        $.ajax({
            url: "/phong-dieu-khien/nhap-lieu-phong-ban-tieu-chi/cap-nhat-thong-tin",
            type: "post",
            data: {
                "data": data,
                'month': $("#monthCalendar").val().split(" ")[1],
                'year': $("#yearCalendar").val().split(" ")[1],
                'department': $("#cbx-px").val()
            },
            success: function (response) {
              successAlert('Thành công','Thao tác thành công');
                tableBody = $("#aspectDetailTable").children("tbody");
                tableBody.empty();
                content = "";
                let reponseListPhongBanTieuChi = response.listPhongBanTieuChi;
                if (reponseListPhongBanTieuChi.length > 1) {
                    for (let i = 0; i < reponseListPhongBanTieuChi.length; i++) {
                        content += "<tr><td class=\"aspectName\" id=\"" + reponseListPhongBanTieuChi[i].MaTieuChi + "\">" + reponseListPhongBanTieuChi[i].TenTieuChi + "</td><tr>";
                    }
                } else {

                }
                tableBody.html(content);
                ViewMode();
                mode = 0;
                listAspectDepartments = response.listTieuChi;
                //$("#totalDays").attr("value", response.totalDays)
                //$("#headerIDhidden").attr("value", response.headerID)
                //$("#totalDays").attr("disable", "disable")
                $('#pre-load').hide();
            },
            error: function (response) {
                errorAlert('Lỗi','Có lỗi xảy ra , vui lòng nhập lại');
                 $('#pre-load').hide();
            }
        })
    }
      function searchUnit(txtMaTieuChiAdd) {
            var tmp = {
                MaTieuChi: txtMaTieuChiAdd.value
            };
            //if (event.key === 'click') {
                $.ajax({
                    type: "POST",
                    url: "/phong-dieu-khien/ke-hoach-san-xuat/returnunit",
                    data: JSON.stringify(tmp),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (r) {
                        document.getElementById("unit"+ txtMaTieuChiAdd.id.slice(-1)).value = r.DonViDo;


                    }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                        $('#pre-load').hide();
                        //alert("co");
                    }

                });
            //}
        }

</script>
<script src="~/lib/datepicker_src/dist/js/i18n/datepicker.vi.js"></script>
<script src="~/js/Custom JS/Disable_input_material.js"></script>
<script src="~/js/Custom JS/form-input-border.js"></script>




