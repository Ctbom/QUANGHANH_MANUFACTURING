@{
    ViewData["Title"] = "sua-chua-chon";
    Layout = "~/Views/Shared/_Layout_CDVT.cshtml";
}

<div class="card">
    <div class="card-content">
        <div class="row">
            <div class="col m12">
                <div class="center">
                    <h3><b>CHI TIẾT SỬA CHỮA</b></h3>
                </div>
                <div class="col s3 m3">
                    <textarea name="data" hidden value="" id="json"></textarea>
                    <label for="department_id_to">Sửa chữa tại <i class="fa fa-asterisk" style="font-size:10px;color:red"></i></label>
                    <input id="department_id_to" name="department_id_to" type="text" required class='form-control' list="departmentName" value="@ViewBag.department_id" />
                </div>
                <div class="col s3 m3">
                    <label for="out_in_come">Nguồn vốn <i class="fa fa-asterisk" style="font-size:10px;color:red"></i></label>
                    <input id="out_in_come" name="out_in_come" class="form-control" type="text" />
                </div>
                <div class="col s3 m3">
                    <label for="reason">Nội dung <i class="fa fa-asterisk" style="font-size:10px;color:red"></i></label>
                    <input id="reason" name="reason" class="form-control" type="text" required />
                </div>
                <div class="col s12 table_container">
                    <table id="mytablevattu" class="striped table-responsive center table-bordered">
                        <thead>
                            <tr>
                                <th class="center-align">Mã thiết bị</th>
                                <th class="center-align">Tên thiết bị</th>
                                <th class="center-align">Số lượng</th>
                                <th class="center-align">Loại sửa chữa <i class="fa fa-asterisk" style="font-size:10px;color:red"></i></th>
                                <th class="center-align">Lý do sửa chữa <i class="fa fa-asterisk" style="font-size:10px;color:red"></i></th>
                                <th class="center-align">Ngày dự kiến xong <i class="fa fa-asterisk" style="font-size:10px;color:red"></i></th>
                                <th></th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (QUANGHANHCORE.Controllers.CDVT.Quyetdinh.SuaChua.ThemController._Equipment item in ViewBag.DataThietBi)
                            {
                                <tr>
                                    <td>@(item.equipmentId + (item.attachTo == null ? "" : ($" ({item.attachTo})")))</td>
                                    <td>@item.equipment_name</td>
                                    <td>@item.quantity</td>
                                    <td>
                                        <select class='form-control'><option>Thường xuyên</option><option>Sự cố</option></select>
                                    </td>
                                    <td>
                                        <input type='text' required class='form-control' />
                                    </td>
                                    <td>
                                        <input type='text' required class='center datepicker-here form-control minDate' data-language='vi' />
                                    </td>
                                    <td>
                                        <a class="vattu btn blue darken-2 modal-trigger" data-equipmentid="@item.equipmentId" data-attachto="@item.attachTo" href="#vattu">Vật tư cần</a>
                                    </td>
                                    <td>
                                        @if (item.attachTo == null)
                                        {
                                            <a class="thietbi btn blue darken-2 modal-trigger" data-equipmentid="@item.equipmentId" href="#thietbi">Thiết&nbsp;bị&nbsp;con&nbsp;cần</a>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <br />
                <div class="col l12 m12 s12 center">
                    <form action="/phong-cdvt/quyet-dinh/sua-chua/chon-thiet-bi" method="get">
                        <input name="selected" value='@Html.Raw(ViewBag.selected)' hidden />
                        <a id="export-button" class="btn blue darken-2">Xuất quyết định</a>
                        <a id="submit" class="btn blue darken-2 modal-trigger">Tạo quyết định sửa chữa</a>
                        <button type="submit" class="btn blue darken-2 ">Quay lại</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="vattu">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Danh sách vật tư dùng để sửa chữa <span></span></h3>
        </div>
        <div class="modal-body">
            <div class="row">
                <form>
                    <table id="test" class="striped table-responsive center table-bordered mytable">
                        <thead>
                            <tr>
                                <th>Mã vật tư</th>
                                <th>Tên vật tư</th>
                                <th>Số lượng xin cấp</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </form>
            </div>
        </div>
        <div class="modal-footer">
            <a id="addrow" class="waves-effect waves-light btn blue darken-2 left">Thêm</a>
            <a id="submitvattu" class="waves-effect waves-light btn blue darken-2 modal-close">Lưu</a>
            <button type="button" class="btn light-blue lighten-1 modal-close">Thoát</button>
        </div>
    </div>
</div>

<div class="modal" id="thietbi">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Danh sách thiết bị đi kèm cần sửa chữa của <span></span></h3>
        </div>
        <div class="modal-body">
            <div class="row">
                <form>
                    <table id="test" class="striped table-responsive center table-bordered mytable">
                        <thead>
                            <tr>
                                <th>Mã thiết bị con</th>
                                <th>Tên thiết bị con</th>
                                <th>Số lượng xin cấp</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </form>
            </div>
        </div>
        <div class="modal-footer">
            <a class="waves-effect waves-light btn blue darken-2 modal-close">Lưu</a>
            <button type="button" class="btn light-blue lighten-1 modal-close">Thoát</button>
        </div>
    </div>
</div>

<div class="modal" id="confirm">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Bạn có muốn tạo quyết định này không?</h3>
        </div>
        <div class="modal-footer">
            <a id="create" class="waves-effect waves-light btn blue darken-2 center">Tạo</a>
            <a class="btn light-blue lighten-1 modal-close center">Thoát</a>
        </div>
    </div>
</div>

<datalist id="departmentName">
    @foreach (var item in ViewBag.Departments)
    {
        <option value="@item.department_id">@item.department_name</option>
    }
</datalist>

<script src="~/js/Custom JS/CDVT/QuyetDinh/datePicker.js"></script>
<script>
    var output = {};
    var equipmentId, attachTo;

    $(document).ready(function () {
        $('input[required]').each(function myfunction() {
            $(this).attr("oninvalid", "setCustomValidity('Không được bỏ trống ô này')");
            $(this).attr("oninput", "this.setCustomValidity('')");
        })

        $('.vattu').click(function () {
            equipmentId = $(this).data("equipmentid");
            attachTo = $(this).data("attachto");
            let url = "@Url.Action("GetSupplyBigEquip", "MethodChung")";
            if (attachTo)
                url = "@Url.Action("GetSupplySmallEquip", "MethodChung")";
            $('#vattu tbody').empty();
            $('#pre-load').show();
            $.ajax({
                url: url,
                method: "post",
                dataType: "json",
                cache: false,
                data: {
                    equipmentId: equipmentId
                },
                success: function (response) {
                    if (response.success) {
                        for (let i = 0; i < response.data.length; i++) {
                            let $tr = $('<tr>').append(
                                $('<td>').text(response.data[i].supply_id),
                                $('<td>').text(response.data[i].supply_name),
                                $('<td>').html("<input type='number' class='form-control' />")
                            )
                            $tr.appendTo('#vattu tbody');
                        }
                    }
                    $('#pre-load').hide();
                },
                error: function () {
                    $('#pre-load').hide();
                }
            })
        })

        $('.thietbi').click(function () {
            equipmentId = $(this).data("equipmentid");
            $('#thietbi tbody').empty();
            $('#pre-load').show();
            $.ajax({
                url: "@Url.Action("GetSmallEquip", "MethodChung")",
                method: "post",
                dataType: "json",
                cache: false,
                data: {
                    equipmentId: equipmentId
                },
                success: function (response) {
                    if (response.success) {
                        for (let i = 0; i < response.data.length; i++) {
                            let $tr = $('<tr>').append(
                                $('<td>').text(response.data[i].equipmentId),
                                $('<td>').text(response.data[i].equipment_name),
                                $('<td>').html("<input type='number' class='form-control' />")
                            )
                            $tr.appendTo('#thietbi tbody');
                        }
                    }
                    $('#pre-load').hide();
                },
                error: function () {
                    $('#pre-load').hide();
                }
            })
        })
    })
</script>