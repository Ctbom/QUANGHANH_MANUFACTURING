
@{
    ViewBag.Title = "Xincapvattu1";

    if (Session["departName"].ToString().Contains("Phân xưởng"))
    {
        Layout = "~/Views/Shared/_Layout_PhanXuong.cshtml";
    }
    else
    {
        Layout = "~/Views/Shared/_Layout_CDVT.cshtml";
    }
}

@*@{
        List<string> list = (List<string>)Session["RightIDs"];
    }*@
<link href="~/assets/Custom css/CDVT/TABLE_BORDERED.css" rel="stylesheet" />
<link href="~/lib/datepicker_src/dist/css/datepicker.min.css" rel="stylesheet" type="text/css">
<link href="~/lib/datepicker_src/dist/css/datepicker.min.css " rel="stylesheet " type="text/css ">
<link href="~/lib/datepicker_src/dist/css/custom.css " rel="stylesheet " type="text/css ">
<link href="~/lib/datepicker_src/dist/css/font.css" rel="stylesheet" type="text/css">
<script src="~/lib/datepicker_src/dist/js/datepicker.js"></script>
<script src="~/lib/datepicker_src/dist/js/i18n/datepicker.vi.js"></script>
<link href="~/assets/Custom css/form-input-border.css" rel="stylesheet" />
<style>
    .duplicate {
        border: 1px solid red !important;
        color: red !important;
    }
</style>
<div class="card">
    <div class="card-content">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="col m12">
                    <ul class="tabs" style="overflow-x:hidden; overflow-y:hidden">
                        <li class="tab col s12 m6 l6"><a class="active" href="#xincapvattu">XIN CẤP VẬT TƯ SỬA CHỮA THƯỜNG XUYÊN</a></li>
                        <li class="tab col s12 m6 l6"><a href="#duyetcap">Duyệt Cấp</a></li>
                    </ul>
                    <hr />
                </div>

                <div id="xincapvattu">

                    <div class="center">

                        <h3><b>XIN CẤP VẬT TƯ SỬA CHỮA THƯỜNG XUYÊN</b></h3>



                    </div>

                    <div id="table-wrapper2" class="col s12 table_container">
                        <table id="myequipment" class="striped table-responsive centered table-bordered mytable">
                            <thead>
                                <tr>
                                    <th class="center-align">Mã Thiết Bị</th>
                                    <th class="center-align">Tên Thiết Bị</th>
                                    <th class="center-align">Vật tư SCTX</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>

                    </div>
                    <div class="modal-footer">
                        <a href="#myaleart" id="summitsupply" class="btn blue darken-2  save-category modal-trigger"> XIN CẤP</a>
                    </div>




                    <div class="modal fade" style="width: 950px" id="listvattu">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">Danh Sách Vật Tư </h3>
                            </div>
                            <table id="mysupply" class="centered striped table-bordered">
                                <thead>
                                    <tr>
                                        <th>Mã thiết bi vật tư</th>
                                        <th>Tên thiết bị vật tư (Mã hiệu - quy cách)</th>
                                        <th>ĐVT</th>
                                        <th>Số lượng còn</th>
                                        <th>Định mức chung</th>
                                        <th>Số lượng xin cấp</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <div class="modal-footer">
                            <a class="left"><button id="them" type="submit" class="btn light-blue lighten-1"><i class="large material-icons">add</i></button></a>
                            @*<a class="left"><button id="remove" onclick="deleterowedit('supplyMaintain_edit')" class="btn light-blue lighten-1"><i class="large material-icons">remove</i></button></a>*@
                            <button type="button" id="submitedit" class="btn light-blue lighten-1">Lưu</button>
                            <button type="button" id="closeForm1" class="btn light-blue lighten-1 modal-close">Thoát</button>
                        </div>
                    </div>

                    <div id="myaleart" class="modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">Xác nhận muốn xin cấp tất cả các vật tư này</h3>
                            </div>
                            <div class="modal-body">
                                <p class="red-text">Dữ liệu không thể phục hồi sau thao tác này</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" id="xincap" class="btn blue darken-2 modal-close">Lưu</button>
                                <button type="button" id="exit" class="btn red modal-close" id="close">Hủy</button>
                            </div>
                        </div>
                    </div>
                </div>
                @*@//////////////////
                    duyệt cấp
                    ///////////////////////*@
                <div id="duyetcap">

                    <div class="center">

                        <h3><b>Duyệt Cấp</b></h3>
                    </div>

                    <div id="table-wrapper2" class="col s12 table_container">
                        <table id="myequipmentconfirm" class="striped table-responsive centered table-bordered mytable">
                            <thead>
                                <tr>
                                    <th class="center-align">Mã Thiết Bị</th>
                                    <th class="center-align">Tên Thiết Bị</th>

                                    <th class="center-align">Vật tư SCTX</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>

                    </div>





                    <div class="modal fade" style="width: 950px" id="listvattuconfirm">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">Danh Sách Vật Tư </h3>
                            </div>
                            <table id="mysupplyconfirm" class="centered striped table-bordered">
                                <thead>
                                    <tr>

                                        <th>Mã thiết bi vật tư</th>
                                        <th>Tên thiết bị vật tư (Mã hiệu - quy cách)</th>
                                        <th>ĐVT</th>
                                        <th>Số lượng xin cấp</th>
                                        <th>Số lượng cấp</th>
                                        <th>Số lượng thực lĩnh</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <div class="modal-footer">

                            <button type="button" id="submiteditconfirm" class="btn light-blue lighten-1 modal-close">Lưu</button>
                            <button type="button" id="closeForm1confirm" class="btn light-blue lighten-1 modal-close">Thoát</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>



<datalist id="supplyID">
    @foreach (var item in ViewBag.listSupply)
    {
        <option value="@item.supply_id">@item.supply_name</option>
    }
</datalist>


<script>
    var count;

    $(document).ready(function () {

        $("#them").click(function () {
            count++;
            $("#mysupply").append("<tr id=\"supply" + count + "\">" +
                "<td><input list='supplyID' type='text' class='form-control myclass supplyid' placeholder='Mã vật tư'id='supplyid" + count + "' onchange='searchMaThietBiVatTu(this)' /><input type='hidden' class='form-control supplyplanid'/><input type='hidden' class='form-control' id='equipmentid'/></td >" +
                "<td><input type='text' class='form-control supplyname' placeholder='Tên vật tư' id='supply_name" + count + "'readonly/></td>" +
                "<td><input type='text' class='form-control unit' placeholder='Đơn vị' id='unit" + count + "' readonly/></td >" +
                "<td><input type='number' class='form-control remaining_amount' placeholder='Số lượng còn lại'id='remainning_amount" + count + "' readonly/></td>" +
                "<td><input type='number' class='form-control general' placeholder='Định mức chung' /></td>" +
                "<td><input type='number' class='form-control xin_cap' placeholder='Số lượng xin cấp' /></td>" +
                "<td><a ><button id='remove' name='supply" + count + "' class='btn light-blue lighten-1'><i class='large material-icons'>remove</i></button></a></td>" +
                "</tr>");
        });
    });

</script>


<script>
    //function for date.
    $('.maxDate').datepicker({
        language: 'vi',
        maxDate: new Date(),
        minDate: new Date("1/1/1900")
    })
    $('.minDate').datepicker({
        language: 'vi',
        maxDate: new Date() // Now can select only dates, which goes after today
    })

</script>

@section scripts{
    @*<script src="~/js/Custom JS/CDVT/Car/car.js"></script>
        <script src="~/js/Custom JS/CDVT/Work/Mobilize_PlaceAndTime.js"></script>*@
    <script src="//cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>
    <script src="~/assets/sweetalert/sweetalert2.min.js"></script>
    <script src="~/assets/sweetalert/sweetalert2.all.min.js"></script>
    <script src="~/assets/sweetalert/alert-quanghanh-js.js"></script>

    <script src="~/js/Custom JS/CDVT/Vattu/validateInput.js"></script>
    <script>

        $(document).ready(function () {

            drawTable();

        });
        function drawTable() {
            dataTable = $('#myequipment').on('preXhr.dt', function (e, settings, data) {
                $("#pre-load").show("slow", function () {
                });
                $("#pre-load").css("z-index", "99999");
            }).DataTable({
                "language": {
                    "emptyTable": "Không có dữ liệu",
                    "paginate": {
                        "first": "Đầu",
                        "last": "Cuối",
                        "next": "Sau",
                        "previous": "Trước"
                    }
                },
                "ajax": {
                    "url": "/phan-xuong/xin-cap-vat-tu-sctx/getinformation",
                    "type": "POST",
                    "datatype": "json",

                    "cache": "false"
                },
                "drawCallback": function (settings) {
                    ///////////////////////ẨN SAU MỖI AJAX CALL////////////////////////
                    $("#pre-load").hide("slow", function () {
                    });
                    ////////////////////////////////////////////////
                },
                "columns": [
                    { "data": "equipmentId", "name": "equipmentId" },
                    { "data": "equipment_name", "name": "equipment_name" },

                    {
                        "data": "equipmentId", "render": function (data) {
                            return "<a href=\"#listvattu\" data-toggle=\"modal\" class=\"open-EditModal waves-effect waves-light btn blue darken-1 modal-trigger\"onclick=setEquipmentID(" + data + ") data-equipmentId=\"" + data + "\">Danh&nbsp;Sách&nbsp;Vật&nbsp;Tư </a>";
                        },
                        "orderable": false,

                        "searchable": false,
                        "width": "150px"
                    }
                ],

                "serverSide": true,
                "rowId": "equipmentId",
                "bLengthChange": false,
                "bFilter": false,
                "bInfo": false,
                "bAutoWidth": false,
                "order": [0, "asc"],
                "initComplete": function (settings, json) {
                    ////////////////////////////////////////////////ẨN KHI KHỞI TẠO TABLE XONG  ////////////////////////////////////////////////
                    $("#pre-load").hide("slow", function () {
                    });
                }
            });
        }

        var equipmentid;
        $(document).on("click", ".open-EditModal", function () {
            $("#mysupply").find("tr:gt(0)").remove();
            equipmentid = $(this).data('equipmentid');

            $.ajax({
                type: "POST",
                url: "/phan-xuong/xin-cap-vat-tu-sctx/getListSupply",
                dataType: "json",
                success: function (data) {



                    $.each(data, function (i, item) {
                        //Danh sách vật tư.
                        i++;

                        var $tr = $('<tr>').append(

                            $('<td>').html('<input type="text" class="form-control supplyid" id="supplyid' + i + '" placeholder="Mã thiết bị vật tư"  value="' + item.supplyid + '"onchange="searchMaThietBiVatTu(this)" list="supplyID"/><input type="hidden" class="form-control supplyplanid"   value="' + item.id + '"/> <input type="hidden" class="form-control" id="equipmentid" />'),

                            $('<td>').html('<input type="text" class="form-control supplyname"id="supply_name' + i + '" placeholder="Tên thiết bị vật tư" name="supplyname_name" value="' + item.supply_name + '" readonly/><input type="hidden" class=\"dem\"value="' + i + '"  >'),
                            $('<td>').html('<input type="text" class="form-control unit " placeholder="Đơn vị" id="unit' + i + '" name="unit" value="' + item.unit + '" readonly/>'),
                            $('<td>').html('<input type="number" class="form-control remaining_amount" placeholder="Số lượng còn lại" id="remainning_amount' + i + '" value="' + item.quantity + '" readonly/>'),

                            $('<td>').html('<input type="number" class="form-control general" placeholder="Định mức chung"  value="' + item.dinh_muc + '"/>'),
                            $('<td>').html('<input type="number" class="form-control xin_cap" placeholder="Số lượng xin cấp" value="' + item.quantity_plan + '"/>'),

                        );

                        $tr.appendTo('#mysupply TBODY');
                    })
                    var a = document.getElementsByClassName("dem").length;
                    if (a == null) { count = 0; }
                    else { count = a; }

                    //dem = document.getElementsByClassName("dem")[document.getElementsByClassName("dem").length - 1].innerText;
                    //dem1 = $("#dem1").text();



                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    errorAlert('Lỗi', 'Có lỗi xảy ra');
                },
                data: {
                    equipmentId: equipmentid
                },
                cache: false
            })
        })




        $("#submitedit").click(function (e) {
            var $supplyid = $(".supplyid");
            var listsupplyid = [];
            $supplyid.each(function () {
                var value = $(this).val();
                if (listsupplyid.indexOf(value) == -1) {
                    listsupplyid.push(value);
                    $(this).removeClass("duplicate");
                }
                else {
                    $(this).addClass("duplicate");
                }
            });
            var $supplyplanid = $(".supplyplanid");
            var listsupplyplanid = [];
            $supplyplanid.each(function () {
                listsupplyplanid.push($(this).val())
            });
            var $general = $(".general");
            var listgeneral = [];
            $general.each(function () {
                listgeneral.push($(this).val())
            });
            var $xin_cap = $(".xin_cap");
            var listxin_cap = [];
            $xin_cap.each(function () {
                listxin_cap.push($(this).val())
            });
            if ($(".duplicate").length > 0) {

                errorAlert('Lỗi', 'Những vật tư này đã xin cấp');
            }
            else {
                $.ajax({
                    type: "POST",
                    url: "/phan-xuong/xin-cap-vat-tu-sctx/editoradd",
                    data: {
                        equipmentid: equipmentid,
                        'supplyid': JSON.stringify(listsupplyid),
                        'general': JSON.stringify(listgeneral),
                        'xin_cap': JSON.stringify(listxin_cap),
                        'supplyplanid': JSON.stringify(listsupplyplanid),
                    },
                    success: function (data) {

                        successAlert('Thành công', data.message);
                        $('#listvattu').modal('close');


                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        $('#pre-load').hide();
                        errorAlert('Lỗi', 'Có lỗi xảy ra , vui lòng nhập lại');
                        $('#close1').click();
                    },
                    cache: false
                })

                return false;
            }
        });
        $("#mysupply").on("click", "#remove", function () {
            $("tr#" + $(this).attr("name")).remove();
        })
        function searchMaThietBiVatTu(txtMaThietBiVatTu) {
            var tmp = {
                supplyid: txtMaThietBiVatTu.value,
                equipmentid: equipmentid
            };

            $.ajax({
                type: "POST",
                url: "/phan-xuong/xin-cap-vat-tu-sctx/returnsupplymaintainName",
                data: JSON.stringify(tmp),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (r) {
                    $(txtMaThietBiVatTu).closest("tr").find(".supplyname").val(r.supply_name);
                    $(txtMaThietBiVatTu).closest("tr").find(".unit").val(r.unit);
                    $(txtMaThietBiVatTu).closest("tr").find(".remaining_amount").val(r.quantity);
                    //document.getElementById("supply_name" + txtMaThietBiVatTu.id.slice(-1)).value = r.supply_name;
                    //document.getElementById("unit" + txtMaThietBiVatTu.id.slice(-1)).value = r.unit;
                    //document.getElementById("remainning_amount" + txtMaThietBiVatTu.id.slice(-1)).value = r.quantity;
                }, error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $('#pre-load').hide();
                    //alert("fail");

                }
            });

        }
        $("#xincap").click(function (e) {
            $.ajax({
                type: "POST",
                url: "/phan-xuong/xin-cap-vat-tu-sctx/xincap",

                success: function () {
                    $("#summitsupply").attr("disabled", true);
                    successAlert('Thành công', 'Xin cấp thành công');
                    $('#myequipment').DataTable().ajax.reload()
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $('#pre-load').hide();
                    errorAlert('Lỗi', 'Có lỗi xảy ra , vui lòng nhập lại');
                    $('#close1').click();
                },
                cache: false
            }).done(function () {

                $('#exit').click();


            })

            return false;
        });
        ///////////////////
        //Duyệt Cấp
        ///////////////////////
        $(document).ready(function () {
            drawTableDuyetCap();
        });
        function drawTableDuyetCap() {
            dataTableConfirm = $('#myequipmentconfirm').on('preXhr.dt', function (e, settings, data) {
                $("#pre-load").show("slow", function () {
                });
                $("#pre-load").css("z-index", "99999");
            }).DataTable({
                "language": {
                    "emptyTable": "Không có dữ liệu",
                    "paginate": {
                        "first": "Đầu",
                        "last": "Cuối",
                        "next": "Sau",
                        "previous": "Trước"
                    }
                },
                "ajax": {
                    "url": "/phan-xuong/xin-cap-vat-tu-sctx/duyet-cap/getinformation",
                    "type": "POST",
                    "datatype": "json",

                    "cache": "false"
                },
                "drawCallback": function (settings) {
                    ///////////////////////ẨN SAU MỖI AJAX CALL////////////////////////
                    $("#pre-load").hide("slow", function () {
                    });
                    ////////////////////////////////////////////////
                },
                "columns": [
                    { "data": "equipmentId", "name": "equipmentId" },
                    { "data": "equipment_name", "name": "equipment_name" },

                    {
                        "data": "equipmentId", "render": function (data) {
                            return "<a href=\"#listvattuconfirm\" data-toggle=\"modal\" class=\"open-EditModalConfirm waves-effect waves-light btn blue darken-1 modal-trigger\" data-equipmentId=\"" + data + "\">Danh&nbsp;Sách&nbsp;Vật&nbsp;Tư </a>";
                        },
                        "orderable": false,

                        "searchable": false,
                        "width": "150px"
                    }
                ],

                "serverSide": true,
                "rowId": "equipmentId",
                "bLengthChange": false,
                "bFilter": false,
                "bInfo": false,
                "bAutoWidth": false,
                "order": [0, "asc"],
                "initComplete": function (settings, json) {
                    ////////////////////////////////////////////////ẨN KHI KHỞI TẠO TABLE XONG  ////////////////////////////////////////////////
                    $("#pre-load").hide("slow", function () {
                    });
                }
            });

        }
        var equipmentId_duyetcap;
        inputNumber(mysupplyconfirm);
        var lists = [];
        $(document).on("click", ".open-EditModalConfirm", function () {
            lists = [];
            $("#mysupplyconfirm").find("tr:gt(0)").remove();

            equipmentId_duyetcap = $(this).data('equipmentid');

            $.ajax({
                type: "POST",
                url: "/phan-xuong/xin-cap-vat-tu-sctx/duyet-cap/getListSupply",
                dataType: "json",
                success: function (res) {

                    resultArray = res.data;
                    var tbData = "";

                    for (var i = 0; i < resultArray.length; i++) {
                        tbData += "<tr>" +

                            "<td class=\"row-auto-span\">" + resultArray[i].supplyid + "</td>" +
                            "<td>" + resultArray[i].supply_name + "</td>" +
                            "<td>" + resultArray[i].unit + "</td>" +
                            "<td>" + resultArray[i].quantity_plan + "</td>" +
                            "<td>" + resultArray[i].quantity_provide + "</td>" +
                            "<td><input type='number' id='quantity-" + resultArray[i].id + "'class='form-control' value='" + resultArray[i].quantity + "'></td>" +

                            "</tr>";
                        lists.push({
                            "id": resultArray[i].id,
                            "equipmentid": resultArray[i].equipmentid,
                            "supplyid": resultArray[i].supplyid,
                            "quantity": ""
                        });
                    }

                    $("#mysupplyconfirm").find("tbody").append(tbData);

                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    errorAlert('Lỗi', 'Có lỗi xảy ra');
                },
                data: {
                    equipmentId: equipmentId_duyetcap
                },
                cache: false
            })
        });
        $("#submiteditconfirm").click(function () {
            for (var i = 0; i < lists.length; i++) {
                lists[i].quantity = $("#quantity-" + lists[i].id).val()
            }
            var data = {
                listvattu: lists,

            };

            $("#pre-load").show();
            $.ajax({
                dataType: "json",
                contentType: "application/json, charset=utf-8",
                type: 'POST',
                url: '/phan-xuong/xin-cap-vat-tu-sctx/duyet-cap/edit',
                data: JSON.stringify(data),
                success: function (res) {
                    $("#pre-load").hide();
                    successAlert('Thành công', 'Chỉnh sửa thành công');
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $("#pre-load").hide();
                    errorAlert('Lỗi', 'Có lỗi xảy ra');
                },
            });
        });


    </script>
}
