
@{
    ViewBag.Title = "NSLD";
    Layout = "~/Views/Shared/PX/_Layout_PXKT.cshtml";
}

<link href="~/assets/Custom css/PX/PXKT/ReportProduct.css" rel="stylesheet" />
<link href="~/dist/css/pages/data-table.css" rel="stylesheet" />
<link href="~/assets/extra-libs/DataTables/datatables.min.css" rel="stylesheet" />
<script src="~/assets/extra-libs/DataTables/datatables.min.js"></script>
<link href="~/assets/sweetalert/sweetalert2.min.css" rel="stylesheet" />
<link href="~/assets/libs/toastr/build/toastr.min.css" rel="stylesheet">
<style>
    #toast-container {
        min-width: 10%;
        top: 0;
        right: 50%;
        transform: translateX(50%) translateY(50%);
    }

    .page-title {
        display: inline !important;
    }
    /*.select-wrapper{
         width: 15% !important;
    }*/
</style>

<script>
    @*$(document).ready(function () {
        var url_string = window.location.href;
        var url = new URL(url_string);
        var c = url.searchParams.get("Ca");
        var time = url.searchParams.get("Date");
        $("#px").html("Khai thác 1");[Auther(RightID = "129")]
        $("#ca").html("CA 1");
        var donvi = url.searchParams.get("Donvi");
        if (donvi == null) {
            donvi = 'KT1';
        }
        var text = document.getElementsByName(donvi)[0].innerHTML;
        if (donvi != null) {
            $("#px").html(text);
            $("#px").attr("name", donvi)
        }

        if (c == 1) {
            $("#ca").html("CA 1");
        }
        if (c == 2) {
            $("#ca").html("CA 2");
        }
        if (c == 3) {
            $("#ca").html("CA 3");
        }
        $("#dropdown_ca").on("click", ".dropdown-child-ca", function () {
            select = $(this).attr("name");
            text = $(this).text();
            $("#ca").html(text);
            $("#ca").attr("name", text);
            $(".dropdown-child-ca").attr("name", select);
            $('.dropdown-trigger').dropdown('close');
        });
        if (time == null) {
            document.getElementById("inputdate").value = "@string.Format("{0:dd/MM/yyyy}", System.DateTime.Now)";
        } else {
            document.getElementById("inputdate").value = time;
        }
        dataTable = $("#content-table").DataTable({
            "language": {
                emptyTable: "<li class='text-danger' align='center'>Không có dữ liệu</li>",
                paginate:
                {
                    previous: "Trang trước",
                    next: "Trang sau",
                    first: "|<",
                    last: ">|",

                },
                info: "Đang hiện _START_ đến _END_ của _TOTAL_ bản ghi",
                infoEmpty: "Đang hiện 0 đến 0 của 0 bản ghi",
            },
            "autoWidth": false,
            "searching": false,
            "drawCallback": function () {
                $('#pre-load').hide();
            }
        });
    });*@

</script>

<div class="card">
    <div class="card-content">
        @*<form>*@
        <div class="page-title row center">
            <h3>
                <b>KHỐI LƯỢNG CÔNG VIỆC</b>
            </h3>
            <div class="row">
                <div class="col s12 m2 l2">
                </div>
                <div class="col s12 m2 l2">
                    <select class="form-control center" id="phongbanSearch">
                        <option value="-1" selected>Chọn phòng ban</option>
                        @foreach (var item in @ViewBag.TenToChuc)
                        {
                            <option value="@item.department_id">@item.department_name</option>
                        }
                    </select>
                </div>
                <div class="col s12 m2 l2">
                    <select class="form-control center" id="caSearch">
                        <option value="-1" selected>Chọn ca</option>
                        <option value="1">Ca 1</option>
                        <option value="2">Ca 2</option>
                        <option value="3">Ca 3</option>
                    </select>
                </div>
                <div class="col l3 l3">
                    <input id="chon-ngay" class="thoigian center form-control" />
                </div>
                <div class="col l2 l2">
                    <button class="btn waves-effect waves-light blue" id="viewBtn">Xem</button>
                </div>
                <div class="col l2 l2">
                </div>
            </div>

            <br><br>

            <hr>
        </div>
        <div class="row table1" style="overflow-x:auto!important">
            <table id="content-table" class="table table-bordered table-responsive centered highlight">
                <thead>
                    <tr>
                        <th style="display:none;"></th>
                        <th width="3%">STT</th>
                        <th width="10%">Tên</th>
                        <th width="5%">Số thẻ</th>
                        <th width="5%">Bậc thợ</th>
                        <th width="10%">Chức danh công việc,thợ chính,thợ phụ</th>
                        <th width="10%">Nội dung công việc,vị trí làm việc</th>
                        <th width="10%">Khối lượng công việc thực hiện được</th>
                        <th width="10%">Hệ số chia lương</th>
                        <th width="10%">Lương</th>
                        <th>Dự báo nguy cơ</th>
                        <th>-Yêu cầu BPKTAT<br>-Giải pháp loại trừ nguy cơ</th>
                    </tr>
                </thead>
                <tbody id="contentNSLD">
                    @*<tr>
                            <td style="display:none;"><input class="madiemdanh" value="@item.ID" /></td>
                            <td>@item.STT</td>
                            <td>@item.Name</td>
                            <td>@item.SoThe</td>
                            <td>@item.BacTho</td>
                            <td>@item.ChucDanh</td>
                            <td>@item.NoiDungCongViec</td>
                            <td><input type="number" value="@item.NSLD" class="form-control updateNSLD" style="border:none; text-align: center;" id="nsld"></td>
                            <td><input type="number" value="@item.HeSoChiaLuong" class="form-control HeSoChiaLuong" style="border:none; text-align: center;"></td>
                            <td><input type="number" value="@item.LuongTruocDuyet" class="form-control Luong" style="border:none; text-align: center;"></td>
                            <td><textarea class="DuBaoNguyCo">@item.DuBaoNguyCo</textarea></td>
                            <td><textarea class="GiaiPhapNguyCo">@item.YeuCauBPKTAT</textarea></td>
                        </tr>*@
                </tbody>
            </table>
            <div style="margin-top:10px;">
                <a class="btn waves-effect waves-light blue modal-trigger" id="btn-save" href="#modal1">Lưu</a>
            </div>

        </div>
        @*</form>*@
    </div>
</div>

<div id="modal1" class="modal">
    <div class="modal-content">
        <h3><b>Bạn có chắc chắn muốn lưu không?</b></h3>
    </div>
    <div class="modal-footer">
        <a href="#" class="modal-action modal-close waves-effect waves-green btn blue" id="btn_agrr" onclick="Update();">Lưu</a>
        <a href="javascript:void(0);" class="modal-action modal-close waves-effect waves-green btn red">Hủy</a>
    </div>
</div>

<script>
    $("#viewBtn").click(function () {
        var phongbanSearch = $("#phongbanSearch").val();
        var caSearch = $("#caSearch").val();
        var ngaySearch = $("#chon-ngay").val();
        //var data = [];
        //data.push(phongbanSearch);
        //data.push(caSearch);
        //data.push(ngaySearch);
        if (phongbanSearch == -1 || caSearch == -1 || ngaySearch == "") {
            toastr.error('Hãy nhập đầy đủ thông tin', '');
        } else {
            $('#pre-load').show("slow", function () {
            });
            $.ajax({
                type: "post",
                dataType: "json",
                url: "/phan-xuong-khai-thac/nang-suat-lao-dong-getData",
                data: {
                    phongbanSearch: JSON.stringify(phongbanSearch),
                    caSearch: JSON.stringify(caSearch),
                    ngaySearch: JSON.stringify(ngaySearch)
                },
                success: function (response) {
                    if (response.success) {
                        $("#contentNSLD").empty();
                        for (var i = 0; i < response.customNSLDs.length; i++) {
                            $("#contentNSLD").append("<tr>\n");
                            $("#contentNSLD").append("<td style=\"display:none;\"><input class=\"madiemdanh\" value=\"" + response.customNSLDs[i].ID + "\" /></td>\n");
                            $("#contentNSLD").append("<td>" + response.customNSLDs[i].STT + "</td>\n");
                            $("#contentNSLD").append("<td>" + response.customNSLDs[i].Name + "</td>\n");
                            $("#contentNSLD").append("<td>" + response.customNSLDs[i].SoThe + " </td>\n");
                            $("#contentNSLD").append("<td>" + response.customNSLDs[i].BacTho + " </td>\n");
                            $("#contentNSLD").append("<td>" + response.customNSLDs[i].ChucDanh + " </td>\n");
                            $("#contentNSLD").append("<td>" + response.customNSLDs[i].NoiDungCongViec + "</td>\n");
                            $("#contentNSLD").append("<td><input type=\"number\" value=\"" + response.customNSLDs[i].NSLD + "\" class=\"form-control updateNSLD\" style=\"border:none; text-align: center;\" id=\"nsld\"></td>\n");
                            $("#contentNSLD").append("<td><input type=\"number\" value=\"" + response.customNSLDs[i].HeSoChiaLuong + "\" class=\"form-control HeSoChiaLuong\" style=\"border:none; text-align: center;\" ></td>\n");
                            $("#contentNSLD").append("<td><input type=\"number\" value=\"" + response.customNSLDs[i].LuongTruocDuyet + "\" class=\"form-control Luong\" style=\"border:none; text-align: center;\"></td>\n");
                            $("#contentNSLD").append("<td><textarea class=\"DuBaoNguyCo\">" + response.customNSLDs[i].DuBaoNguyCo + "</textarea></td>\n");
                            $("#contentNSLD").append("<td><textarea class=\"GiaiPhapNguyCo\">" + response.customNSLDs[i].YeuCauBPKTAT + "</textarea></td>");
                            $("#contentNSLD").append("</tr>\n");
                        }
                        $('#pre-load').hide("slow", function () {
                        });
                    } else {
                        $('#pre-load').hide("slow", function () {
                        });
                        errorAlert("Lỗi", "");
                    }
                }
            })
        }
    })
</script>
<script>
    var ca;
    var intCa;
    function getInner() {
        intCa = $("#caSearch").val();
    }
</script>
<script>
    function getcontent() {
        $('#pre-load').show("slow", function () {
        });
        var phongbanSearch = $("#phongbanSearch").val();
        var caSearch = $("#caSearch").val();
        var ngaySearch = $("#chon-ngay").val();
        //var data = [];
        //data.push(phongbanSearch);
        //data.push(caSearch);
        //data.push(ngaySearch);
        $.ajax({
            type: "post",
            dataType: "json",
            url: "/phan-xuong-khai-thac/nang-suat-lao-dong-getData",
            data: {
                phongbanSearch: JSON.stringify(phongbanSearch),
                caSearch: JSON.stringify(caSearch),
                ngaySearch: JSON.stringify(ngaySearch)
            },
            success: function (response) {
                if (response.success) {
                    $("#contentNSLD").empty();
                    for (var i = 0; i < response.customNSLDs.length; i++) {
                        $("#contentNSLD").append("<tr><td style=\"display:none;\"><input class=\"madiemdanh\" value=\"" + response.customNSLDs[i].ID + "\"/></td>\n");
                        $("#contentNSLD").append("<td>" + response.customNSLDs[i].STT + "</td>\n");
                        $("#contentNSLD").append("<td>" + response.customNSLDs[i].Name + "</td>\n");
                        $("#contentNSLD").append("<td>" + response.customNSLDs[i].SoThe + " </td>\n");
                        $("#contentNSLD").append("<td>" + response.customNSLDs[i].BacTho + " </td>\n");
                        $("#contentNSLD").append("<td>" + response.customNSLDs[i].ChucDanh + " </td>\n");
                        $("#contentNSLD").append("<td>" + response.customNSLDs[i].NoiDungCongViec + "</td>\n");
                        $("#contentNSLD").append("<td><input type=\"number\" value=\"" + response.customNSLDs[i].NSLD + "\" class=\"form-control updateNSLD\" style=\"border:none; text-align: center;\" id=\"nsld\"></td>\n");
                        $("#contentNSLD").append("<td><input type=\"number\" value=\"" + response.customNSLDs[i].HeSoChiaLuong + "\" class=\"form-control HeSoChiaLuong\" style=\"border:none; text-align: center;\" ></td>\n");
                        $("#contentNSLD").append("<td><input type=\"number\" value=\"" + response.customNSLDs[i].LuongTruocDuyet + "\" class=\"form-control Luong\" style=\"border:none; text-align: center;\"></td>\n");
                        $("#contentNSLD").append("<td><textarea class=\"DuBaoNguyCo\">" + response.customNSLDs[i].DuBaoNguyCo + "</textarea></td>\n");
                        $("#contentNSLD").append("<td><textarea class=\"GiaiPhapNguyCo\">" + response.customNSLDs[i].YeuCauBPKTAT + "</textarea></td></tr>\n");

                    }
                    $('#pre-load').hide("slow", function () {
                    });
                } else {
                    errorAlert("Lỗi", "");
                    $('#pre-load').hide("slow", function () {
                    });
                }
            }
        })
    }
</script>
<script>
    $("#chon-ngay").datepicker({
        toggleSelected: false,
        language: 'vi'
    });
    var date = new Date();
    $("#chon-ngay").val(date.getDate() + "/" + (date.getMonth() + 1) + "/" + date.getFullYear());
    $(function () {
        $(".datepicker-inline").remove();
    })
</script>
<script>
    function Update() {
        $('#pre-load').show("slow", function () {
           });
        getInner();
        var MaDiemDanh = document.getElementsByClassName("madiemdanh");
        var NangSuatLaoDong = document.getElementsByClassName("updateNSLD");
        var HeSoChiaLuong = document.getElementsByClassName("HeSoChiaLuong");
        var Luong = document.getElementsByClassName("Luong");
        var DuBaoNguyCo = document.getElementsByClassName("DuBaoNguyCo");
        var GiaiPhapNguyCo = document.getElementsByClassName("GiaiPhapNguyCo");
        var MaDiemDanhs = [];
        var NangSuatLaoDongs = [];
        var HeSoChiaLuongs = [];
        var Luongs = [];
        var DuBaoNguyCos = [];
        var GiaiPhapNguyCos = [];
        for (var i = 0; i < MaDiemDanh.length; i++) {
            var tmpMaDiemDanh = MaDiemDanh[i].value;
            var tmpNangSuatLaoDong = NangSuatLaoDong[i].value;
            var tmpHeSoChiaLuong = HeSoChiaLuong[i].value;
            var tmpLuong = Luong[i].value;
            var tmpDuBaoNguyCo = DuBaoNguyCo[i].value;
            var tmpGiaiPhapNguyCo = GiaiPhapNguyCo[i].value;
            MaDiemDanhs.push(tmpMaDiemDanh);
            NangSuatLaoDongs.push(tmpNangSuatLaoDong);
            HeSoChiaLuongs.push(tmpHeSoChiaLuong);
            Luongs.push(tmpLuong);
            DuBaoNguyCos.push(tmpDuBaoNguyCo);
            GiaiPhapNguyCos.push(tmpGiaiPhapNguyCo);
        }
        var empObj = {
            intCa: intCa,
            MaDiemDanhs: MaDiemDanhs,
            NangSuatLaoDongs: NangSuatLaoDongs,
            HeSoChiaLuongs: HeSoChiaLuongs,
            Luongs: Luongs,
            DuBaoNguyCos: DuBaoNguyCos,
            GiaiPhapNguyCos: GiaiPhapNguyCos,
            date: $("#chon-ngay").val()
        };
        $.ajax({
            url: "/phan-xuong-khai-thac/nang-suat-lao-dong-update",
            data: JSON.stringify(empObj),
            contentType: "application/json;charset=utf-8",
            type: "POST",
            success: function () {
                getcontent();
                $('#pre-load').hide();
                reloadAlert("Thành công!", 2000);
            },
            error: function () {
            }
        });
    }
</script>
@*<script>
        $('#inputdate').datepicker({
            language: 'vi',
            maxDate: new Date() // Now can select only dates, which goes after today
        })
        $(document).ready(function () {
            $('.datepicker-inline').remove();
        });
        $(document).ready(function () {
            $("#type").html("Xem Theo Ngày");
        });
        $("#dropdown_px").on("click", ".dropdown-child-px", function () {
            select = $(this).attr("name");
            text = $(this).text();
            $("#px").html(text);
            $("#px").attr("name", select);
            $(".dropdown-child-px").attr("name", select);
            $('.dropdown-trigger').dropdown('close');
        });

    </script>*@
<script src="~/assets/sweetalert/alert-quanghanh-js.js"></script>
<script src="~/assets/sweetalert/sweetalert2.all.min.js"></script>
<script src="~/assets/sweetalert/sweetalert2.min.js"></script>
<script src="~/js/Custom JS/Disable_input_material.js"></script>
<script src="~/assets/libs/toastr/build/toastr.min.js"></script>
<script src="~/assets/extra-libs/toastr/toastr-init.js"></script>


